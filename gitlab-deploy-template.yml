spec:
  inputs:
    environment:
      default: staging
    stage:
      default: deploy
---
# 必须是pages作为名字
pages:
  stage: deploy
  # tags: [ Self-managed, ubuntu-latest ]
  variables:
    DRAWIO_EDITOR_URL: https://de.vicp.net:25053
    KITY_MINDER_EDITOR_URL: https://de.vicp.net:25053
    ASSETS_FOLDER: ${CI_PROJECT_PATH}/${CI_COMMIT_REF_NAME}/docs/assets
  before_script:
    - |
      if [ "$USING_REPO_README" = "true" ]; then
        echo "Using README.md as docs/index.md"
        cp -f README.md docs/index.md
      else
        echo "Skipping README.md overwrite"
      fi
  script:
    - echo "setup python"
    - |
      env
      pushd ~ || exit 1
      [ -d gitlab-python-sszorg-bulletin ] || {
        python3 -m venv gitlab-python-sszorg-bulletin
      }
      source gitlab-python-sszorg-bulletin/bin/activate
      popd || exit 1
      pwd
    - |
      pip install mkdocs-material jieba
      pip install mkdocs-drawio-km --upgrade
      ./generate_md.sh $(pwd)
      mkdocs build --clean --site-dir public
      mkdocs --version
  artifacts:
    paths:
      - public
  rules: # 多个rule是或的关系
    - changes:
      - docs/**/* # 递归监控子目录发生变化
      - mkdocs.yml
      - .gitlab-ci.yml
      - gitlab-deploy-template.yml
      - README.md
    # - if: $DEPLOY_ENV == "deploy"
    - when: manual  # 兜底规则，避免一直卡住